extends: [autotools_package]

# see https://gcc.gnu.org/install/prerequisites.html
dependencies:
  build: [zlib, mpfr, mpc, gmp, isl, cloog, {{build_with}}]

defaults:
  relocatable: false

sources:
- key: tar.bz2:eaqmtauvqvvkcp62b4xtur4ujedvp7be
  url: http://ftpmirror.gnu.org/gcc/gcc-4.9.2/gcc-4.9.2.tar.bz2

build_stages:
  - name: rpath_patch
    before: rpath_sed
    files: [rpath.patch]
    handler: bash
    bash: |
      patch -up1 < _hashdist/rpath.patch

  - name: rpath_sed
    before: configure
    handler: bash
    bash: |
      sed -i "s|@@ARTIFACT@@|${ARTIFACT}|g" gcc/config/i386/gnu-user.h gcc/config/i386/gnu-user64.h

  - name: link_lib64_to_lib
    after: install
    handler: bash
    bash: |
      # Create symbolic links from lib64/* to lib/
      cd ${ARTIFACT}/lib
      ln -s ../lib64/* .

  # the checks will continue to run and not stop if there are errors,
  # this is here really for post build review.
  - name: make_check
    after: install
    handler: bash
    bash: |
##WIP      echo | ${ARTIFACT}/bin/gcc -v -x c -E -
##WIP      echo | ${ARTIFACT}/bin/gcc -v -x c++ -E -
##WIP      ${ARTIFACT}/bin/gcc -Wl,--verbose
##WIP      ${ARTIFACT}/bin/gfortran -Wl, --verbose
##WIP
##WIP       echo "run gcc checks"
##WIP       make -k check
##WIP       echo "    ok"
##WIP 
##WIP       echo "run test summary script"
##WIP       ./contrib/test_summary
##WIP       echo "    ok"
##WIP

when_build_dependency:
- prepend_path: PATH
  value: '${ARTIFACT}/bin'
