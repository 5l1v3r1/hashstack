parameters:
- name: version
  type: version
  default: 2.4.0
# /bin/git contains hard-coded path
- name: relocatable
  type: bool
  default: false

- name: disable_crypto
  type: bool
  default: false

extends: [autotools_package]

dependencies:
  build: [curl, pcre, openssl, libiconv, gettext, expat, zlib, perl]

sources:
- url: https://www.kernel.org/pub/software/scm/git/git-{{version}}.tar.gz
  key:
    when version == 2.4.0: tar.gz:2wghm2ua3bvf4gcgybghiymotc76yfmh

build_stages:

- name: perl_path
  before: configure
  handler: bash
  bash: |
    export PERL_PATH="/usr/bin/env perl"

- when: platform == 'Darwin' and disable_crypto
  name: fix_crypto_compile_failure
  before: configure
  handler: bash
  bash: |
    export NO_APPLE_COMMON_CRYPTO=1

- name: configure
  mode: override
  extra: ['--with-libpcre=${PCRE_DIR}', '--with-zlib=${ZLIB_DIR}', '--with-iconv=${LIBICONV_DIR}', '--with-expat=${EXPAT_DIR}', '--with-curl=${CURL_DIR}']

when_build_dependency:
- prepend_path: PATH
  value: '${ARTIFACT}/bin'
