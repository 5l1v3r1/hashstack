build_stages:

  # Set up links to system Python. Do not pull in site-packages (or dist-packages).
  # Additionally, use our own fresh site.py (since at least Debian patches it
  # to replace site-packages with dist-packages...).

  - handler: bash
    files: [site.py]
    bash: |
      mkdir ${ARTIFACT}/bin
      cp /usr/bin/python${{pyver}} ${ARTIFACT}/bin/python${{pyver}}
      cp /usr/bin/python${{pyver}}-config ${ARTIFACT}/bin/python${{pyver}}-config
      ln -s python${{pyver}} ${ARTIFACT}/bin/python
      ln -s python${{pyver}}-config ${ARTIFACT}/bin/python-config
      mkdir -p ${ARTIFACT}/lib/python${{pyver}} ${ARTIFACT}/include/python${{pyver}}
      for i in /usr/lib/python${{pyver}}/*; do
        ln -s $i ${ARTIFACT}/lib/python${{pyver}}
      done



      for i in /usr/include/python${{pyver}}/*; do
        ln -s $i ${ARTIFACT}/include/python${{pyver}}
      done
      rm -f ${ARTIFACT}/lib/python${{pyver}}/dist-packages
      rm -f ${ARTIFACT}/lib/python${{pyver}}/site-packages
      mkdir ${ARTIFACT}/lib/python${{pyver}}/site-packages
      cp -f _hashdist/site.py ${ARTIFACT}/lib/python${{pyver}}/site.py

when_build_dependency:
  - set: PYTHON
    value: ${ARTIFACT}/bin/python

profile_links:

  - name: python_binaries
    before: everything
    launcher: 'bin/*'

  - name: everything
    link: '*/**/*'
