parameters:
- name: version
  type: version
  default: 1.5

# lib/python2.7/site-packages/libadjoint/clibadjoint.py contains hard-coded path
- name: relocatable
  type: bool
  default: false

extends: [cmake_package]

dependencies:
  # FIXME: add optional dependencies with a '+'
  build: [gccxml, mpi, petsc, slepc]#, {{build_with}}]

sources:
- key:
    when version == 1.5: tar.gz:pvs4t2nxqssi6mwagvg5oqqhryhhj7ft
  url: https://bitbucket.org/dolfin-adjoint/libadjoint/get/libadjoint-{{version}}.tar.gz

build_stages:
- name: configure
  mode: override
  extra: ['-D CMAKE_CXX_COMPILER:FILEPATH=${MPICXX}',
          '-D CMAKE_C_COMPILER:FILEPATH=${MPICC}',
          '-D CMAKE_Fortran_COMPILER:FILEPATH=${MPIF90}']

# There is a bug when using -j option to make, so disable it for now.
- name: make
  mode: replace
  handler: bash
  after: configure
  bash: |
    make

- name: install
  mode: replace
  handler: bash
  after: make
  bash: |
    make install

when_build_dependency:
- prepend_path: PYTHONPATH
  value: '${ARTIFACT}/lib/python{{pyver}}/site-packages'
