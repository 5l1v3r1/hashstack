parameters:
- name: version
  type: version
  default: 0.2.13

- name: extra_flags
  default: ''

# build single threaded version as default
- name: use_thread
  type: bool
  default: false

- name: kind
  default: openblas

# cmake/OpenBLASConfig.cmake contains hard-coded path
- name: relocatable
  type: bool
  default: false

extends: [base_package]

sources:
- url: https://github.com/xianyi/OpenBLAS/archive/v{{version}}.tar.gz
  key:
    when version == 0.2.13: tar.gz:l4pzq2qzackjawfvpddbyk3fwtpdetyz
    when version == 0.2.14: tar.gz:eqi4j5lpi55ufx7vjwzlp76aw7hvho4x

build_stages:
- name: make_and_install
  after: prologue
  handler: bash
  bash: |
    make USE_THREAD={{int(use_thread)}} {{extra_flags}} -j${HASDIST_CPU_COUNT}
    make {{extra_flags}} PREFIX=${ARTIFACT} install

when_build_dependency:
- {set: 'BLAS_LDFLAGS', value: '-Wl,-rpath,${ARTIFACT}/lib -L${ARTIFACT}/lib -lopenblas'}
- {set: 'LAPACK_LDFLAGS', value: '-Wl,-rpath,${ARTIFACT}/lib -L${ARTIFACT}/lib -lopenblas'}
- {set: 'OPENBLAS_DIR', value: '${ARTIFACT}'}
