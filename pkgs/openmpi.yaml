parameters:
- name: version
  type: version
  default: 1.6.5

# lib/openmpi/mca_carto_auto_detect.la contains hard-coded path
- name: relocatable
  type: bool
  default: false

extends: [autotools_package]

sources:
- url: http://www.open-mpi.org/software/ompi/v{{'.'.join(str(version).split('.')[:-1])}}/downloads/openmpi-{{version}}.tar.bz2
  key:
    when version == 1.6.5: tar.bz2:7y33voe3l3zdjyfmqlohtaucykvqreal

build_stages:
- name: configure
  extra:
    - '--enable-mpi-thread-multiple'
    - '--enable-opal-multi-threads'
    - '--with-threads=posix'
    - '--disable-mpi-profile'
    - when platform == 'linux':
      - '--with-wrapper-ldflags=-Wl,-rpath=${ARTIFACT}/lib'
    - when platform == 'Darwin':
      - '--with-wrapper-ldflags=-Wl,-rpath,${ARTIFACT}/lib'

when_build_dependency:
- {set: 'MPICC', value: "${ARTIFACT}/bin/mpicc"}
- {set: 'MPICXX', value: "${ARTIFACT}/bin/mpic++"}
- {set: 'MPIF77', value: "${ARTIFACT}/bin/mpif77"}
- {set: 'MPIF90', value: "${ARTIFACT}/bin/mpif90"}
- {set: 'MPIEXEC', value: "${ARTIFACT}/bin/mpiexec"}

- prepend_path: PATH
  value: ${ARTIFACT}/bin
